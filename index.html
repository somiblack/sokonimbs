<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SokoniMbs - Buy Mbs ChapChap!</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .bundle-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .bundle-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .badge {
            font-size: 0.75rem;
            background-color: #facc15;
            color: #1f2937;
            padding: 2px 6px;
            border-radius: 9999px;
            margin-left: 0.5rem;
        }
        .whatsapp-float {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #25D366;
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: transform 0.2s;
        }
        .whatsapp-float:hover {
            transform: scale(1.1);
        }
        
        /* Modal Styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Toast Styles */
        .toast {
            animation: toastSlideIn 0.3s ease-out;
        }
        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .toast.toast-exit {
            animation: toastSlideOut 0.3s ease-in;
        }
        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        /* Loading Spinner */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #10b981;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Phone Input Styling */
        .phone-input {
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .phone-input:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        .phone-input.error {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        
        /* Button Animations */
        .btn-primary {
            transition: all 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .btn-secondary {
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-100 font-sans">
    <header class="bg-gradient-to-r from-green-600 to-blue-500 text-white p-4 shadow-lg">
        <div class="max-w-6xl mx-auto flex flex-col sm:flex-row justify-between items-center text-center sm:text-left">
            <h1 class="text-xl font-bold tracking-wide">SokoniMbs.co.ke</h1>
            <span class="text-sm italic mt-1 sm:mt-0">Buy Mbs ChapChap at Sokoni!</span>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 sm:p-6">
        <div class="mb-8 text-center">
            <h2 class="text-3xl font-bold text-green-700 mb-2">Available Offers</h2>
            <p class="text-gray-600">Affordable & Instant Safaricom Bundles, Airtime & Minutes</p>
        </div>

        <div class="mb-6">
            <h3 class="text-2xl font-semibold text-blue-700 mb-4 text-center sm:text-left">Data Offers - <span class="text-green-600">Hot Offers</span></h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bundle-card bg-yellow-100 rounded-lg p-4 shadow-md text-center">
                    <h3 class="text-lg font-bold">1.25GB till Midnight</h3>
                    <p class="text-gray-800">Ksh 55</p>
                    <div class="mt-3 space-y-2">
                        <button onclick="buyBundle('1.25GB till Midnight', 55, false)" class="btn-primary w-full bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg font-medium">Buy Now</button>
                        <button onclick="buyBundle('1.25GB till Midnight', 55, true)" class="btn-secondary w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">Buy for Another</button>
                    </div>
                </div>
                <div class="bundle-card bg-yellow-100 rounded-lg p-4 shadow-md text-center">
                    <h3 class="text-lg font-bold">1.2GB - 30 Days</h3>
                    <p class="text-gray-800">Ksh 250</p>
                    <div class="mt-3 space-y-2">
                        <button onclick="buyBundle('1.2GB - 30 Days', 250, false)" class="btn-primary w-full bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg font-medium">Buy Now</button>
                        <button onclick="buyBundle('1.2GB - 30 Days', 250, true)" class="btn-secondary w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">Buy for Another</button>
                    </div>
                </div>
                <div class="bundle-card bg-yellow-100 rounded-lg p-4 shadow-md text-center">
                    <h3 class="text-lg font-bold">350MB - Weekly</h3>
                    <p class="text-gray-800">Ksh 49</p>
                    <div class="mt-3 space-y-2">
                        <button onclick="buyBundle('350MB - Weekly', 49, false)" class="btn-primary w-full bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg font-medium">Buy Now</button>
                        <button onclick="buyBundle('350MB - Weekly', 49, true)" class="btn-secondary w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">Buy for Another</button>
                    </div>
                </div>
                <div class="bundle-card bg-yellow-100 rounded-lg p-4 shadow-md text-center">
                    <h3 class="text-lg font-bold">1GB - 1 Hour</h3>
                    <p class="text-gray-800">Ksh 19</p>
                    <div class="mt-3 space-y-2">
                        <button onclick="buyBundle('1GB - 1 Hour', 19, false)" class="btn-primary w-full bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg font-medium">Buy Now</button>
                        <button onclick="buyBundle('1GB - 1 Hour', 19, true)" class="btn-secondary w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">Buy for Another</button>
                    </div>
                </div>
                <div class="bundle-card bg-yellow-100 rounded-lg p-4 shadow-md text-center">
                    <h3 class="text-lg font-bold">250MB - 24 Hours</h3>
                    <p class="text-gray-800">Ksh 20</p>
                    <div class="mt-3 space-y-2">
                        <button onclick="buyBundle('250MB - 24 Hours', 20, false)" class="btn-primary w-full bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg font-medium">Buy Now</button>
                        <button onclick="buyBundle('250MB - 24 Hours', 20, true)" class="btn-secondary w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">Buy for Another</button>
                    </div>
                </div>
                <div class="bundle-card bg-yellow-100 rounded-lg p-4 shadow-md text-center">
                    <h3 class="text-lg font-bold">1GB - 24 Hours</h3>
                    <p class="text-gray-800">Ksh 99</p>
                    <div class="mt-3 space-y-2">
                        <button onclick="buyBundle('1GB - 24 Hours', 99, false)" class="btn-primary w-full bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg font-medium">Buy Now</button>
                        <button onclick="buyBundle('1GB - 24 Hours', 99, true)" class="btn-secondary w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">Buy for Another</button>
                    </div>
                </div>
                <div class="bundle-card bg-red-100 rounded-lg p-4 shadow-md text-center">
                    <h3 class="text-lg font-bold">2.5GB - 7 Days</h3>
                    <p class="text-gray-800">Ksh 300</p>
                    <div class="mt-3 space-y-2">
                        <button onclick="buyBundle('2.5GB - 7 Days', 300, false)" class="btn-primary w-full bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg font-medium">Buy Now</button>
                        <button onclick="buyBundle('2.5GB - 7 Days', 300, true)" class="btn-secondary w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">Buy for Another</button>
                    </div>
                </div>
                <div class="bundle-card bg-red-100 rounded-lg p-4 shadow-md text-center">
                    <h3 class="text-lg font-bold">6GB - 7 Days</h3>
                    <p class="text-gray-800">Ksh 700</p>
                    <div class="mt-3 space-y-2">
                        <button onclick="buyBundle('6GB - 7 Days', 700, false)" class="btn-primary w-full bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg font-medium">Buy Now</button>
                        <button onclick="buyBundle('6GB - 7 Days', 700, true)" class="btn-secondary w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">Buy for Another</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-6">
            <h3 class="text-2xl font-semibold text-blue-700 mb-4 text-center sm:text-left">Data Offers - <span class="text-purple-600">Monthly Packages</span></h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bundle-card bg-purple-100 rounded-lg p-4 shadow-md text-center">
                    <h3 class="text-lg font-bold">1.2GB - 30 Days</h3>
                    <p class="text-gray-800">Ksh 250</p>
                    <div class="mt-3 space-y-2">
                        <button onclick="buyBundle('1.2GB - 30 Days', 250, false)" class="btn-primary w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-medium">Buy Now</button>
                        <button onclick="buyBundle('1.2GB - 30 Days', 250, true)" class="btn-secondary w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">Buy for Another</button>
                    </div>
                </div>
                <div class="bundle-card bg-purple-100 rounded-lg p-4 shadow-md text-center">
                    <h3 class="text-lg font-bold">2.5GB - 30 Days</h3>
                    <p class="text-gray-800">Ksh 500</p>
                    <div class="mt-3 space-y-2">
                        <button onclick="buyBundle('2.5GB - 30 Days', 500, false)" class="btn-primary w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-medium">Buy Now</button>
                        <button onclick="buyBundle('2.5GB - 30 Days', 500, true)" class="btn-secondary w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">Buy for Another</button>
                    </div>
                </div>
                <div class="bundle-card bg-purple-100 rounded-lg p-4 shadow-md text-center">
                    <h3 class="text-lg font-bold">10GB - 30 Days</h3>
                    <p class="text-gray-800">Ksh 1001</p>
                    <div class="mt-3 space-y-2">
                        <button onclick="buyBundle('10GB - 30 Days', 1001, false)" class="btn-primary w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-medium">Buy Now</button>
                        <button onclick="buyBundle('10GB - 30 Days', 1001, true)" class="btn-secondary w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">Buy for Another</button>
                    </div>
                </div>
                <div class="bundle-card bg-purple-100 rounded-lg p-4 shadow-md text-center">
                    <h3 class="text-lg font-bold">8GB + 400 Min - 30 Days</h3>
                    <p class="text-gray-800">Ksh 1000</p>
                    <div class="mt-3 space-y-2">
                        <button onclick="buyBundle('8GB + 400 Min - 30 Days', 1000, false)" class="btn-primary w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-medium">Buy Now</button>
                        <button onclick="buyBundle('8GB + 400 Min - 30 Days', 1000, true)" class="btn-secondary w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">Buy for Another</button>
                    </div>
                </div>
                <div class="bundle-card bg-purple-100 rounded-lg p-4 shadow-md text-center">
                    <h3 class="text-lg font-bold">300 Min - 30 Days</h3>
                    <p class="text-gray-800">Ksh 500</p>
                    <div class="mt-3 space-y-2">
                        <button onclick="buyBundle('300 Min - 30 Days', 500, false)" class="btn-primary w-full bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-medium">Buy Now</button>
                        <button onclick="buyBundle('300 Min - 30 Days', 500, true)" class="btn-secondary w-full bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-medium text-sm">Buy for Another</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-10 p-4 text-center text-sm text-red-700 bg-yellow-200 rounded shadow">
            ‚ö†Ô∏è Kindly note: You can only purchase <strong>one package per day</strong>, and a new day begins at <strong>midnight</strong>.
        </div>

        <div class="mt-6 p-4 text-center text-sm text-green-900 bg-green-100 rounded shadow">
            üí≥ To purchase manually, send payment to <strong>Till Number: 4288958</strong><br>
            Recipient Name: <strong>Shem Kirimi</strong>
        </div>

        <div class="mt-10 p-4 text-center text-sm text-blue-800 bg-blue-100 rounded shadow">
            üõçÔ∏è Visit our <a href="https://sokoni.co.ke/" class="underline text-blue-900 font-semibold" target="_blank">main site Sokoni.co.ke</a> for more digital deals and offers.
        </div>
    </main>

    <!-- Purchase Modal -->
    <div id="purchaseModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay fixed inset-0" onclick="closeModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content bg-white rounded-xl shadow-2xl max-w-md w-full p-6 relative">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Complete Purchase</h3>
                    <p id="bundleDetails" class="text-gray-600"></p>
                </div>

                <form id="purchaseForm" onsubmit="processPurchase(event)">
                    <!-- Recipient Phone Number (always shown) -->
                    <div class="mb-4">
                        <label for="recipientPhone" class="block text-sm font-medium text-gray-700 mb-2">
                            <span id="recipientLabel">Recipient's Phone Number</span>
                        </label>
                        <input 
                            type="tel" 
                            id="recipientPhone" 
                            class="phone-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none"
                            placeholder="0712345678"
                            maxlength="12"
                            required
                        >
                        <p id="recipientError" class="text-red-500 text-sm mt-1 hidden"></p>
                        <p class="text-gray-500 text-xs mt-1">Enter the Safaricom number to receive the bundle</p>
                    </div>

                    <!-- Payer Phone Number (only shown for "Buy for Another") -->
                    <div id="payerSection" class="mb-4 hidden">
                        <label for="payerPhone" class="block text-sm font-medium text-gray-700 mb-2">
                            Payer's Phone Number
                        </label>
                        <input 
                            type="tel" 
                            id="payerPhone" 
                            class="phone-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none"
                            placeholder="0712345678"
                            maxlength="12"
                        >
                        <p id="payerError" class="text-red-500 text-sm mt-1 hidden"></p>
                        <p class="text-gray-500 text-xs mt-1">Enter the phone number that will pay for this bundle</p>
                    </div>

                    <div class="flex space-x-3">
                        <button 
                            type="button" 
                            onclick="closeModal()" 
                            class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit" 
                            id="purchaseBtn"
                            class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition-colors flex items-center justify-center"
                        >
                            <span id="purchaseBtnText">Purchase Now</span>
                            <div id="purchaseSpinner" class="spinner ml-2 hidden"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <a href="https://wa.me/254704166953" class="whatsapp-float" target="_blank" aria-label="Chat on WhatsApp">
        üí¨
    </a>

    <script>
        let currentBundle = null;
        let isForAnother = false;

        // Phone number formatting and validation
        function formatPhoneNumber(value) {
            // Remove all non-digits
            let digits = value.replace(/\D/g, '');
            
            // Handle different input formats
            if (digits.startsWith('254')) {
                digits = digits.slice(3); // Remove country code
            } else if (digits.startsWith('0')) {
                digits = digits.slice(1); // Remove leading zero
            }
            
            // Limit to 9 digits (after removing 0 or 254)
            digits = digits.slice(0, 9);
            
            return digits;
        }

        function validatePhoneNumber(phone) {
            const digits = formatPhoneNumber(phone);
            // Safaricom numbers: 7xxxxxxxx or 1xxxxxxxx (9 digits after removing 0)
            return /^[17]\d{8}$/.test(digits);
        }

        function displayPhoneNumber(phone) {
            const digits = formatPhoneNumber(phone);
            
            if (digits.length === 0) return '';
            
            // Always start with 0
            let formatted = '0' + digits;
            
            // Add spaces for better readability
            if (digits.length >= 3) {
                formatted = `0${digits.slice(0, 3)} ${digits.slice(3, 6)} ${digits.slice(6)}`.trim();
            }
            
            return formatted;
        }

        // Setup phone input handlers
        function setupPhoneInput(inputId, errorId) {
            const phoneInput = document.getElementById(inputId);
            const phoneError = document.getElementById(errorId);

            phoneInput.addEventListener('input', function(e) {
                const cursorPosition = e.target.selectionStart;
                const oldValue = e.target.value;
                const newValue = displayPhoneNumber(e.target.value);
                
                // Update the input value
                e.target.value = newValue;
                
                // Restore cursor position (approximately)
                const lengthDiff = newValue.length - oldValue.length;
                const newCursorPosition = Math.min(cursorPosition + lengthDiff, newValue.length);
                e.target.setSelectionRange(newCursorPosition, newCursorPosition);
                
                // Validate only if user has entered something
                if (newValue.length > 1) {
                    if (!validatePhoneNumber(newValue)) {
                        phoneInput.classList.add('error');
                        phoneError.textContent = 'Please enter a valid Safaricom number (07xxxxxxxx or 01xxxxxxxx)';
                        phoneError.classList.remove('hidden');
                    } else {
                        phoneInput.classList.remove('error');
                        phoneError.classList.add('hidden');
                    }
                } else {
                    phoneInput.classList.remove('error');
                    phoneError.classList.add('hidden');
                }
            });

            phoneInput.addEventListener('keydown', function(e) {
                // Allow backspace, delete, tab, escape, enter
                if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                    // Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true) ||
                    // Allow home, end, left, right
                    (e.keyCode >= 35 && e.keyCode <= 39)) {
                    return;
                }
                // Ensure that it is a number and stop the keypress
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });

            phoneInput.addEventListener('paste', function(e) {
                setTimeout(() => {
                    const value = e.target.value;
                    e.target.value = displayPhoneNumber(value);
                }, 10);
            });
        }

        // Initialize phone inputs when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setupPhoneInput('recipientPhone', 'recipientError');
            setupPhoneInput('payerPhone', 'payerError');
        });

        // Toast notification system
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            toast.className = `toast ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg max-w-sm`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-1">${message}</div>
                    <button onclick="removeToast(this.parentElement.parentElement)" class="ml-4 text-white hover:text-gray-200">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => removeToast(toast), 5000);
        }

        function removeToast(toast) {
            toast.classList.add('toast-exit');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }

        // Modal functions
        function buyBundle(bundleName, price, forAnother = false) {
            currentBundle = { name: bundleName, price: price };
            isForAnother = forAnother;
            
            document.getElementById('bundleDetails').textContent = `${bundleName} - Ksh ${price}`;
            
            // Update labels and visibility based on purchase type
            if (forAnother) {
                document.getElementById('recipientLabel').textContent = 'Recipient\'s Phone Number';
                document.getElementById('payerSection').classList.remove('hidden');
                document.getElementById('payerPhone').required = true;
            } else {
                document.getElementById('recipientLabel').textContent = 'Your Phone Number';
                document.getElementById('payerSection').classList.add('hidden');
                document.getElementById('payerPhone').required = false;
            }
            
            document.getElementById('purchaseModal').classList.remove('hidden');
            
            // Clear and focus the recipient phone input
            const recipientInput = document.getElementById('recipientPhone');
            const payerInput = document.getElementById('payerPhone');
            
            recipientInput.value = '';
            payerInput.value = '';
            recipientInput.classList.remove('error');
            payerInput.classList.remove('error');
            document.getElementById('recipientError').classList.add('hidden');
            document.getElementById('payerError').classList.add('hidden');
            
            setTimeout(() => recipientInput.focus(), 100);
        }

        function closeModal() {
            document.getElementById('purchaseModal').classList.add('hidden');
            document.getElementById('purchaseForm').reset();
            document.getElementById('recipientPhone').classList.remove('error');
            document.getElementById('payerPhone').classList.remove('error');
            document.getElementById('recipientError').classList.add('hidden');
            document.getElementById('payerError').classList.add('hidden');
        }

        // Purchase processing
        async function processPurchase(event) {
            event.preventDefault();
            
            const recipientInput = document.getElementById('recipientPhone');
            const payerInput = document.getElementById('payerPhone');
            const recipientPhone = recipientInput.value;
            const payerPhone = payerInput.value;
            
            // Validate recipient phone
            if (!validatePhoneNumber(recipientPhone)) {
                recipientInput.classList.add('error');
                document.getElementById('recipientError').textContent = 'Please enter a valid Safaricom number';
                document.getElementById('recipientError').classList.remove('hidden');
                return;
            }

            // Validate payer phone if buying for another
            if (isForAnother) {
                if (!validatePhoneNumber(payerPhone)) {
                    payerInput.classList.add('error');
                    document.getElementById('payerError').textContent = 'Please enter a valid Safaricom number';
                    document.getElementById('payerError').classList.remove('hidden');
                    return;
                }
            }

            // Show loading state
            const purchaseBtn = document.getElementById('purchaseBtn');
            const purchaseBtnText = document.getElementById('purchaseBtnText');
            const purchaseSpinner = document.getElementById('purchaseSpinner');
            
            purchaseBtn.disabled = true;
            purchaseBtnText.textContent = 'Processing...';
            purchaseSpinner.classList.remove('hidden');

            try {
                // Format phone numbers for API (254xxxxxxxxx)
                const formattedRecipientPhone = '254' + formatPhoneNumber(recipientPhone);
                const formattedPayerPhone = isForAnother ? '254' + formatPhoneNumber(payerPhone) : formattedRecipientPhone;
                
                const response = await fetch('/stk-push', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: currentBundle.price,
                        phone: formattedPayerPhone, // The phone that will pay
                        recipientPhone: formattedRecipientPhone // The phone that will receive the bundle
                    })
                });

                const result = await response.json();

                if (response.ok && result.ResponseCode === '0') {
                    const message = isForAnother 
                        ? `Payment request sent to ${displayPhoneNumber(payerPhone)}! Bundle will be sent to ${displayPhoneNumber(recipientPhone)}.`
                        : `Payment request sent! Check your phone for M-Pesa prompt.`;
                    showToast(message, 'success');
                    closeModal();
                } else {
                    throw new Error(result.errorMessage || 'Payment failed');
                }
            } catch (error) {
                console.error('Purchase error:', error);
                showToast(`Purchase failed: ${error.message}`, 'error');
            } finally {
                // Reset loading state
                purchaseBtn.disabled = false;
                purchaseBtnText.textContent = 'Purchase Now';
                purchaseSpinner.classList.add('hidden');
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>